<!DOCTYPE html>
<html>
<head>
	<title>Yard Problem</title>
	<style type="text/css">
		canvas {
			border: 3px solid black;
		}

		div {
			width:100%;
			text-align:center;
		}
	</style>
</head>
<body>
	<div>
		<canvas id="myCanvas" width="675" height="675"></canvas>
	</div>
	<button onclick="showIndividual(idIndividual)">Show next</button>
	<label>1</label>
	<script type="text/javascript">
		var c = document.getElementById("myCanvas");
		var ctx = c.getContext("2d");
		var unit = 15;
		//c.style.width = (unit * 45)+"px";
		//c.style.height = (unit * 45)+"px";
		console.log("The size of canvas should be "+unit*45);

		var dibujarCuadricula = function(){
			// Horizontal lines
			
			//ctx.strokeStyle = 'orange';
			for(var i=1; i<45; i++){
				ctx.beginPath();
				if(i%5===0){
					ctx.strokeStyle = 'orange';
				} else {
					ctx.strokeStyle = 'blue';
				}

				ctx.moveTo(i*unit,0);
				ctx.lineTo(i*unit,unit*45);
				ctx.stroke();	
			}
			// Vertical lines
			for(var i=1; i<45; i++){
				ctx.beginPath();
				if(i%5===0){
					ctx.strokeStyle = 'orange';
				} else {
					ctx.strokeStyle = 'blue';
				}

				ctx.moveTo(0,i*unit);
				ctx.lineTo(45*unit,i*unit);
				ctx.stroke();	
			}	
		}

		var getLinesPointsInd = function(pnts){
			var res = [];
			var inclinaciones = [];
			for(var i = 0; i < pnts.length; i++){
				inclinaciones[i] = [];
				for(var e = 0; e < pnts.length; e++){
					if(e !== i){
						inclinaciones[i][e] = (pnts[i][0]-pnts[e][0])/(pnts[i][1]-pnts[e][1]);
					}
				}
			}

			for(var i = 0; i < inclinaciones.length; i++){
				var pro = inclinaciones[i].reduce((pv,cv,ci)=>{
					if(pv.cv){
						pv.cv.push(ci);
					} else {
						pv.cv = [ci];
					}
					return pv;
				});

				var keys = Object.keys(pro);

				keys.forEach(key=>{
					if(pro[key].length==4){
						if(res.indexOf(i)!==-1){
							res.push(i);
						}
						pro[key].forEach(val=>{
							if(res.indexOf(val)==-1){
								res.push(val);
							}
						});
					}
				});
			}

			return res;
		}

		var cruzar = function(pnts1,pnts2){
			var pre = [];
			var ind1 = getLinesPointsInd(pnts1);
			var ind2 = getLinesPointsInd(pnts2);

			for(var i=0; i < ind1.length; i++){
				pre.push(pnts1[i]);
			}

			for(var i=0; i < ind2.length; i++){
				pre.push(pnts1[i]);
			}			

			var numRandom = 24 - pre.length;

			var new1 = [];
			for(var i = 0; i < numRandom; i++){
				var x,y;
				do{
					x = Math.floor((Math.random()*44)+1);
					y = Math.floor((Math.random()*44)+1);
				}while(pre.map(val=>{return val.join(",")}).indexOf([x,y].join(","))!==-1);
				new1.push[x,y];
			}

			var new2 = [];
			for(var i = 0; i < numRandom; i++){
				var x,y;
				do{
					x = Math.floor((Math.random()*44)+1);
					y = Math.floor((Math.random()*44)+1);
				}while(pre.map(val=>{return val.join(",")}).indexOf([x,y].join(","))!==-1);
				new2.push[x,y];
			}

			pnts1 = pre.slice(0).concat(new1);
			pnts2 = pre.slice(0).concat(new2);
		}

		var getRandomNumberWithNoRepetition = function(cantidad){
			var res = [];
			for(var i = 0; i< cantidad;i++){
				var tmp = Math.floor(Math.random()*cantidad);
				while(res.indexOf(tmp)!==-1){
					tmp = Math.floor(Math.random()*cantidad);
				}
				res.push(tmp);
			}
			return res;
		}
		
		var createRandomIndividual = function(){
			// Points array
			var points = [];

			var tmpNum ;
			// Getting random x numbers
			for(var i=0; i<24; i++){
				tmpNum = Math.floor((Math.random()*44)+1);
				points[i] = [tmpNum,0];
			}

			// Getting random y numbers
			for(var i=0; i<24; i++){
				
				tmpNum = Math.floor((Math.random()*44)+1);
				var exists;
				do{
					exists = false;
					for(var e = 0; e < i; e++){
						if(points[i].join("&")==[points[i][0],tmpNum].join("&")){
							exists = true;
						}
					}
				} while (exists)
				

				points[i][1] = tmpNum;
			}

			// Aqui se va a quitar los elementos que sean mayor a 4 en una misma linea
			var inclinaciones = [];
			var numOfLines = 0;

			var entro = true;

			while(entro){
				entro = false;
			
				for (var i = 0; i < points.length; i++) {
					inclinaciones[i] = [];
					for (var e = i+1 ; e < points.length; e++) {
						if(i!==e){
							inclinaciones[i][e] = (points[i][0]-points[e][0])/(points[i][1]-points[e][1]);	
						}
					}	
				}
				
				for(var i = 0; i < inclinaciones.length; i++){
					var tmp = inclinaciones[i].reduce((pv,cv,ci)=>{
						if(pv[cv]){
							pv[cv].push(ci);
						} else {
							pv[cv] = [ci];
						}
						return pv;
					},{});

					var keys = Object.keys(tmp);
				
					keys.forEach(val=>{
						if(tmp[val].length>3){
							// Reemplazamos esos numero con otro
							for(var e=3;e<tmp[val].length;e++){
								// Este es el indice a reemplazar tmp[val][e]
								points[tmp[val][e]] = null;
								// Generar un nuevo numero
								var newX,newY;
								do{
									newX = Math.floor(Math.random()*44)+1;
									newY = Math.floor(Math.random()*44)+1;
									if(points.join(",").indexOf([newX,newY].join(","))!==-1){
										this.entro = true;	
									}
								}while(points.join(",").indexOf([newX,newY].join(","))!==-1)
								// Revisar que no existan duplicados
								// Reemplazar el viejo por el nuevo numero
								points[tmp[val][e]] = [newX,newY].slice(0);
							}
						}
					});	
				}
			}


			return points;
		}

		// Function to evaluate to the individual
		var evaluateIndividual = function(pnts){
			var inclinaciones = [];
			var numOfLines = 0;

			for (var i = 0; i < pnts.length; i++) {
				inclinaciones[i] = [];
				for (var e = i+1 ; e < pnts.length; e++) {
					inclinaciones[i][e] = (pnts[i][0]-pnts[e][0])/(pnts[i][1]-pnts[e][1]);
				}	
				
			}


			for(var i = 0; i < inclinaciones.length; i++){
				var tmp = inclinaciones[i].reduce((pv,cv,ci)=>{
					if(pv[cv]){
						pv[cv]++;
					} else {
						pv[cv] = 1;
					}
					return pv;
				},{});

				var keys = Object.keys(tmp);

				keys.forEach(val=>{
					if(tmp[val]==3){
						numOfLines++;
					}
				})
			}
			
			return numOfLines;
		}
			
		// Drawing all points of the first generation
		var idIndividual = 0;
		var showIndividual = function(id){
			document.getElementsByTagName("label")[0].innerHTML = id;
			ctx.clearRect(0, 0, c.width, c.height);
			dibujarCuadricula();
			for(var i=0; i < 24; i++){
				ctx.beginPath();
				ctx.moveTo(poblacion[id][i][0]*unit,45*unit-poblacion[id][i][1]*unit);
		      	ctx.arc(poblacion[id][i][0]*unit,45*unit-poblacion[id][i][1]*unit, 4, 0,2*Math.PI, false);
		      	ctx.fillStyle = 'green';
		      	ctx.fill();
		      	ctx.lineWidth = 0;
		      	ctx.strokeStyle = 'green';
		        ctx.stroke();
			}
			idIndividual++;
			if(idIndividual==numOfIndividualPerGeneration){
				idIndividual = 0;
			}
		}

		// Iniciamos a los individuos de la primer generacion
		var poblacion = [];
		var numOfIndividualPerGeneration = 8;
		for(var i = 0; i < numOfIndividualPerGeneration; i++){
			poblacion [i] = createRandomIndividual();
		}

		var mejorEvaluacion = -1;	
		var idMejorEvaluado = -1;

		do{
			// Evaluamos a los individuos
			var evaluaciones = [];
			for(var i = 0; i < numOfIndividualPerGeneration; i++){
				evaluaciones[i] = evaluateIndividual(poblacion[i]);
				if(evaluaciones[i]>mejorEvaluacion){
					mejorEvaluacion = evaluaciones[i];
					idMejorEvaluado = i;
					console.log("mejorEvaluacion => "+mejorEvaluacion);
					console.log("ID mejorEval => "+idMejorEvaluado);
				}
			}

			if(mejorEvaluacion>=10){
				showIndividual(idMejorEvaluado);
				//evaluateIndividual(poblacion[idMejorEvaluado]);
				console.log(idMejorEvaluado)
				document.getElementsByTagName("label")[0].innerHTML = idMejorEvaluado;
				break;
			}

			// Seleccionamos a los competidores del torneo
			var battleOrder = getRandomNumberWithNoRepetition(numOfIndividualPerGeneration);

			// Ganadores
			var winners = [];
			for(var i = 0; i < battleOrder.length/2; i++){
				winners[i] = evaluaciones[battleOrder[i*2]]>evaluaciones[battleOrder[i*2+1]]?battleOrder[i*2]:battleOrder[i*2+1];
			}
			
			// Clonamos ganadores
			var clonados = [];
			for (var i = 0; i < winners.length; i++) {
				clonados[i*2] = winners[i];
				clonados[i*2+1] = winners[i];
			}

			// Seleccionamos parejas a cruzar
			var ordenCruza = getRandomNumberWithNoRepetition(numOfIndividualPerGeneration);

			// Se cruzan los individuos
			for(var i = 0; i < numOfIndividualPerGeneration; i+=2){
				cruzar(poblacion[ordenCruza[i]],poblacion[ordenCruza[i+1]]);
			}
			//break;

			// Mutamos un gen de cada individuo
			for(var i = 0; i < poblacion.length; i++){
				var idGentoMutate = Math.floor(Math.random()*24);
				var exists = false;
				var newX,newY;
				do{
					newX = Math.floor(Math.random()*44)+1;
					newY = Math.floor(Math.random()*44)+1;
					exists = false;
					for(var e = 0; e < poblacion[i].length; e++){
						if(poblacion[i][0]==[newX,newY]){
							exist = true;
						}
					}
				}while(exists);
				poblacion[i][idGentoMutate] = [newX,newY];
				//console.log(poblacion[i].length);
			}
		}while(mejorEvaluacion<10)

		dibujarCuadricula();
		showIndividual(0);

	</script>
</body>
</html>